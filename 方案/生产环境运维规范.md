## 1. 概述

本规范旨在确保生产环境的稳定性、安全性与高可用性，规范运维操作流程，减少人为失误与系统故障。

## 2. 环境定义

- **开发环境（DEV）**：开发人员用于日常开发和调试的环境。
- **测试环境（TEST）**：用于功能测试、集成测试、验收测试等。
- **生产环境（PROD）**：对外提供服务的正式环境，所有业务系统必须高度稳定和安全。

------

## 3. 操作规范

### 3.1 变更管理

- 所有生产变更必须通过变更申请流程（如禅道）并经审批。
- 每次变更需编写变更单，内容包括：变更目的、变更内容、回滚方案、影响评估、操作人等。
- 高风险变更需安排在低峰期进行（如10:00PM-4:00AM）。
- 所有上线操作应在灰度或预发布环境先行验证。

### 3.2 登录与权限

- 禁止直接使用 root 用户登录生产服务器。
- 所有生产主机必须启用操作日志审计。
- 严格控制 sudo 权限，仅授予最小权限。

### 3.3 操作审计

- 启用操作日志记录和命令审计。
- 所有敏感操作需记录操作人、时间、目标系统、操作命令。
- 审计日志保留时间不得少于 6 个月。

------

## 4. 应急响应

### 4.1 告警机制

- 所有关键系统应配置监控及告警，覆盖 CPU、内存、磁盘、端口、服务状态、日志关键字等。
- 告警应发送到负责人群组，并包含事件描述、时间、服务器信息、建议处理方案。
- 告警阈值设置应合理，避免误报和漏报。

### 4.2 故障处理流程

1. 值班人员接到告警后应立即响应；
2. 判断是否为假告警；
3. 若确认故障，立即记录时间并启动应急预案；
4. 故障处理完毕后，撰写事故报告（Postmortem）并总结复盘；
5. 对因人为操作导致的故障追责并组织培训。

------

## 5. 安全规范

### 5.1 网络安全

- 禁止在生产服务器中开放非必要端口；
- 数据传输需加密（如 HTTPS、SSH、VPN）；
- 定期进行安全扫描和漏洞修复。

### 5.2 数据安全

- 所有数据库必须开启访问控制和加密机制；
- 严禁在生产环境中使用测试数据或进行测试操作；
- 定期备份数据（建议每日全备+每小时增量备份）；
- 所有备份需定期校验可用性并存放于异地。

------

## 6. 发布部署规范

- 所有发布流程应通过自动化工具完成（如 Jenkins、GitLab CI/CD、Ansible）；
- 发布流程必须包括回滚机制；
- 发布前必须完成以下 checklist：

- - 变更申请已审批；
  - 回滚包已准备；
  - 核心负责人在线值守；
  - 发布窗口已公告。

## 7. 文档与知识库

- 每次变更、部署、故障处理都必须记录文档并上传至知识库；
- 运维操作手册应定期更新，确保新人可快速上手；
- 故障案例库应进行分类、标签化和复盘记录。

------

## 8. 值班与巡检制度

- 运维团队需安排 7×24 小时值班，明确责任人；
- 每日巡检内容应包括主机健康状态、磁盘空间、关键服务运行状态、异常日志等；
- 巡检结果需记录在案，重大异常需上报并跟进处理。

------

## 10. Kubernetes 运维规范（K8s Operations Standards）

### 10.1 集群管理

- 集群应至少包含三个 master 节点，启用高可用配置；
- 建议使用官方稳定发行版或企业支持版本；
- 集群组件（etcd、controller-manager、scheduler、kubelet、kube-proxy）版本应定期升级，至少每季度评估一次；
- 禁止直接登录工作节点做变更，所有操作应通过 `kubectl` 或 CI/CD 执行；
- 所有节点需安装监控 agent（如 Prometheus Node Exporter）。

### 10.2 命名空间与资源配额

- 按业务、环境（如 `dev`、`test`、`prod`）划分命名空间；
- 每个命名空间应设置资源配额（`ResourceQuota`）与限制（`LimitRange`）；
- 非核心服务应部署在非 `default` 命名空间中。

### 10.3 发布规范

- 所有部署通过 CI/CD 工具执行，禁止手动 apply YAML 文件；
- 建议使用 Helm 或 Kustomize 管理配置；
- 所有 Deployment/StatefulSet/DaemonSet 必须配置：
  - `readinessProbe` 和 `livenessProbe`
  - `resources.limits/requests`
  - 回滚策略（如 `revisionHistoryLimit`, `strategy.rollingUpdate`）
- 发布操作应记录在 CI/CD 流水线中并自动触发告警通知；
- 禁止使用 `latest` 标签，必须指定明确版本号（如 `v1.2.3`）。

### 10.4 日志与监控

- 应统一使用集中式日志方案（如 EFK/ELK、Loki）；
- 应使用 Prometheus + Grafana 监控集群核心组件、Pod 状态、服务调用延迟、QPS、异常指标；
- 启用 K8s Event 导出与分析（如通过 `event-exporter` 或 `kube-state-metrics`）；
- 所有关键服务应具备 SLO/SLA 监控仪表板；
- 每个告警策略应包括触发条件、告警等级、责任人通知方式。

### 10.5 安全规范

- 禁止在容器中使用 root 用户运行服务；
- Pod 默认不应具备 hostNetwork、privileged 权限；
- 强制启用 RBAC，细化角色和权限分配；
- 使用 NetworkPolicy 限制跨命名空间通信；
- 所有 Secret 必须使用加密存储（如启用 KMS 插件）；
- 建议定期进行安全扫描（如使用 kube-bench、trivy、kubescape）。

### 10.6 备份与灾备

- 定期备份 etcd 数据（建议每天备份并保留 7 天）；
- 所有持久化数据（如 PVC）应启用快照备份机制；
- 灾备方案需包括：
  - 集群级恢复流程；
  - 核心服务恢复优先级；
  - 流量切换预案（如使用 DNS、Ingress 控制器或服务网格）。

### 10.7 自动化与巡检

- 每日或每小时执行集群巡检脚本，检测以下内容：
  - 节点状态是否 Ready；
  - Pod 是否存在 CrashLoopBackOff；
  - 服务是否无 Endpoints；
  - 是否存在 Pending 的 PVC；
  - 资源使用是否接近配额；
- 所有巡检结果需记录并保存，异常项需触发通知与排查流程。

------